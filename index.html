<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Backend Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }
        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        .stat-item {
            padding: 15px;
            border: 1px solid #ddd;
            text-align: center;
            border-radius: 5px;
        }
        .progress-bar {
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            margin-top: 5px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            display: block;
            transition: width 0.3s;
        }
        .count {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Real-time Backend Monitor</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div class="controls">
        <button id="reset-all">Reset All Counters</button>
        <button id="reconnect">Reconnect</button>
    </div>
    
    <div class="stats" id="stats-container"></div>
    
    <script>
        const statsContainer = document.getElementById('stats-container');
        const statusElement = document.getElementById('status');
        const resetAllBtn = document.getElementById('reset-all');
        const reconnectBtn = document.getElementById('reconnect');
        
        let ws = null;
        let backendCounts = {};
        
        // Initialize stats containers for all backends
        for (let i = 1; i <= 10; i++) {
            backendCounts[i] = 0;
            
            // Create stat item
            const statItem = document.createElement('div');
            statItem.className = 'stat-item';
            statItem.innerHTML = `
                <div style="background-color: ${getBackendColor(i)}; padding: 5px; border-radius: 5px; color: white;">Backend ${i}</div>
                <div class="count" id="count-${i}">0</div>
                <div class="progress-bar">
                    <span id="progress-${i}" class="progress" style="width: 0%; background-color: ${getBackendColor(i)}"></span>
                </div>
            `;
            statsContainer.appendChild(statItem);
        }
        
        // Function to get color for a backend
        function getBackendColor(backendNum) {
            const colors = {
                1: '#FF5733', 2: '#33FF57', 3: '#3357FF', 4: '#FF33A8', 5: '#33A1FF',
                6: '#A833FF', 7: '#FF8833', 8: '#33FFC4', 9: '#FFEB33', 10: '#F033FF'
            };
            return colors[backendNum] || '#888';
        }
        
        // Function to connect to WebSocket server
        function connectWebSocket() {
            // Close existing connection if any
            if (ws) {
                ws.close();
            }
            
            // Determine WebSocket URL (adjust if hosted elsewhere)
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                statusElement.textContent = 'Connected to monitor';
                statusElement.className = 'status connected';
            };
            
            ws.onclose = function() {
                statusElement.textContent = 'Disconnected from monitor';
                statusElement.className = 'status disconnected';
                
                // Auto-reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = function(err) {
                console.error('WebSocket error:', err);
                statusElement.textContent = 'Error connecting to monitor';
                statusElement.className = 'status disconnected';
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'welcome') {
                        console.log('Connected to monitor:', data.message);
                    }
                    else if (data.type === 'increment') {
                        // Increment the count for the specified backend
                        const backend = data.backend;
                        if (backend >= 1 && backend <= 10) {
                            backendCounts[backend]++;
                            updateStats();
                        }
                    }
                    else if (data.type === 'reset') {
                        // Reset all counters
                        for (let i = 1; i <= 10; i++) {
                            backendCounts[i] = 0;
                        }
                        updateStats();
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };
        }
        
        // Function to update the stats display
        function updateStats() {
            const total = Object.values(backendCounts).reduce((sum, count) => sum + count, 0);
            
            for (let i = 1; i <= 10; i++) {
                const count = backendCounts[i];
                const percentage = total > 0 ? (count / total) * 100 : 0;
                
                document.getElementById(`count-${i}`).textContent = count;
                document.getElementById(`progress-${i}`).style.width = `${percentage}%`;
            }
        }
        
        // Function to reset all counters
        function resetAllCounters() {
            // Send reset command to server
            fetch('/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).catch(error => {
                console.error('Error resetting counters:', error);
            });
        }
        
        // Set up event listeners
        resetAllBtn.addEventListener('click', resetAllCounters);
        reconnectBtn.addEventListener('click', connectWebSocket);
        
        // Initial connection
        connectWebSocket();
    </script>
</body>
</html>
